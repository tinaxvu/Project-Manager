{% extends 'base.html' %}

{% block title %}Project Management Dashboard{% endblock %}

{% block content %}
   <style>
       body {
           background-color: #1a4b7a;
       }
       .dashboard-grid {
           display: grid;
           grid-template-columns: repeat(3, 1fr);
           grid-gap: 20px;
           padding: 20px;
       }
       .dashboard-item {
           padding: 20px;
           text-align: center;
           font-size: 1.2rem;
           border-radius: 15px;
           position: relative;
           color: white;
           min-height: 100px;
       }
       .dashboard-item.pink {
           background-color: #f68fb0;
       }
       .dashboard-item.blue {
           background-color: #6cc5e0;
       }
       .dashboard-item.white-pink {
           background-color: white;
           color: #99044e;
       }
       .dashboard-item a {
           position: absolute;
           bottom: 10px;
           right: 10px;
           color: white;
           font-size: 1.5rem;
           text-decoration: none;
       }
       .delete-project-btn {
           position: absolute;
           top: 10px;
           right: 50px;
           display: inline-block;
           width: 30px;
           height: 30px;
       }
       .create-project-btn {
           position: fixed;
           bottom: 20px;
           right: 20px;
           background-color: #ff007f;
           color: white;
           padding: 10px 20px;
           border-radius: 5px;
           text-decoration: none;
           font-weight: bold;
       }
       .create-project-btn:hover {
           background-color: #cc005f;
       }
   </style>

   {% if user.is_authenticated %}
   <div class="container my-5">
       <h1 class="text-center text-white mt-5">Project Management Dashboard</h1>
       <p class="text-center text-white">Welcome {{ user.first_name }}!</p>
       <p class="text-center text-white">Your Role:</p>
       {% if user.permission_level == 'admin' %}
           <p class="text-center text-white">Admin</p>
       {% else %}
           <p class="text-center text-white">Common</p>
       {% endif %}

       <!-- Your Projects Section -->
       <div class="mt-5">
           <h3 class="text-center text-white">Your Projects</h3>
           <div class="dashboard-grid">
               {% for project in user_projects %}
               <div class="dashboard-item blue">
                   <h2>{{ project.name }}</h2>
                   <p>{{ project.description }}</p>
                   <a href="{% url 'projects:project-detail' project.id %}">&#10132;</a>

                   <!-- Show delete button only for admins -->
                   {% if user.permission_level == 'admin' %}
                       <a href="#" class="delete-project-btn" data-project-id="{{ project.id }}">
                           &#10006;
                       </a>
                   {% endif %}
               </div>
               {% empty %}
               <p class="text-center text-white">You have no projects.</p>
               {% endfor %}
           </div>
       </div>

       <!-- Joined Projects Section -->
       <div class="mt-5">
           <h3 class="text-center text-white">Joined Projects</h3>
           <div class="dashboard-grid">
               {% for project in joined_projects %}
               <div class="dashboard-item blue">
                   <h2>{{ project.name }}</h2>
                   <p>{{ project.description }}</p>
                   <a href="{% url 'projects:project-detail' project.id %}">&#10132;</a>

                   <!-- Show delete button only for admins -->
                   {% if user.permission_level == 'admin' %}
                       <a href="#" class="delete-project-btn" data-project-id="{{ project.id }}">
                           &#10006;
                       </a>
                   {% endif %}
               </div>
               {% empty %}
               <p class="text-center text-white">You are not a member of any projects.</p>
               {% endfor %}
           </div>
       </div>

       <!-- All Projects Section -->
       <div class="mt-5">
           <h3 class="text-center text-white">All Projects</h3>
           <div class="dashboard-grid">
               {% for project in all_projects %}
               <div class="dashboard-item pink">
                   <h2>{{ project.name }}</h2>
                   <p>{{ project.description }}</p>

                   {% if project not in user_projects and project not in joined_projects %}
                       <!-- Check if the user has already requested to join -->
                       {% if project in requested_projects %}
                           <!-- Greyed-out button for already requested projects -->
                           <button class="btn btn-secondary" disabled>Requested</button>
                       {% else %}
                           <!-- Blue "Request to Join" button for new requests -->
                           <button class="btn btn-primary request-to-join-btn" data-project-id="{{ project.id }}">
                               Request to Join
                           </button>
                       {% endif %}
                   {% endif %}
               </div>
               {% empty %}
               <p class="text-center text-white">No other projects available.</p>
               {% endfor %}
           </div>
       </div>
   </div>

   <!-- Create Project Button -->
   {% if user.permission_level != 'admin' %}
       <a href="{% url 'projects:create-project' %}" class="create-project-btn">Create a Project</a>
   {% endif %}
   {% else %}
   <div class="container text-center my-5">
       <h1>Welcome to the PMA</h1>
       <p class="text-center text-white">You are not logged in.</p>
       <p class="text-center">
           <a href="{% url 'social:begin' 'google-oauth2' %}" class="btn btn-light">Login with Google</a>
       </p>
   </div>
   {% endif %}

   <!-- Handle the AJAX submission for Request to Join -->
   <script>
       document.addEventListener('DOMContentLoaded', function() {
           document.querySelectorAll('.request-to-join-btn').forEach(button => {
               button.addEventListener('click', function(event) {
                   const projectId = button.getAttribute('data-project-id');

                   fetch(`/projects/${projectId}/request-to-join/`, {
                       method: 'POST',
                       headers: {
                           'X-CSRFToken': '{{ csrf_token }}',
                           'Content-Type': 'application/json'
                       }
                   }).then(response => response.json())
                   .then(data => {
                       if (data.success) {
                           // Change button to 'Requested' and disable it
                           button.classList.remove('btn-primary');
                           button.classList.add('btn-secondary');
                           button.disabled = true;
                           button.innerHTML = 'Requested';

                           // Show alert
                           alert('Your request has been sent');
                       } else if (data.message === 'Already requested') {
                           // Show already requested alert
                           alert('You have already requested to join this project');
                       } else {
                           alert('Failed to send request');
                       }
                   });
               });
           });
       });
   </script>

{% endblock %}
