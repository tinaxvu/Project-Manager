{% extends 'base.html' %}

{% block title %}Project Management Dashboard{% endblock %}

{% block content %}
<style>
    body {
        background: linear-gradient(135deg, #007bff 0%, #00bfff 50%, #007bff 100%);
        color: #fff;
        min-height: 100vh;
    }
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-gap: 20px;
        padding: 20px;
    }
    .dashboard-item {
        padding: 20px;
        text-align: center;
        font-size: 1.2rem;
        border-radius: 15px;
        position: relative;
        color: white;
        min-height: 100px;
    }
    .dashboard-item.pink {
        background-color: #f68fb0;
    }
    .dashboard-item.blue {
        background-color: #6cc5e0;
    }
    .dashboard-item.white-pink {
        background-color: white;
        color: #99044e;
    }
    .card {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
    }
    .card:hover {
        background-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-5px);
    }
    .create-project-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #ff007f;
        color: white;
        padding: 10px 20px;
        border-radius: 30px;
        text-decoration: none;
        font-weight: bold;
    }
    .create-project-btn:hover {
        background-color: #cc005f;
        transform: scale(1.05);
    }
    .delete-project-btn {
        position: absolute;
        top: 10px;
        right: 50px;
    }
</style>

{% if user.is_authenticated %}
<div class="container my-5">
    <div class="dashboard-header text-center">
        <h1 class="display-4 mb-3">Project Management Dashboard</h1>
        <p class="lead">Welcome {{ user.first_name }}!</p>
        <p>Your Role:
            {% if user.permission_level == 'admin' %}
                <span class="badge bg-primary">Admin</span>
            {% else %}
                <span class="badge bg-secondary">Common</span>
            {% endif %}
        </p>
        <a class="btn btn-outline-light mt-3" href="{% url 'logout' %}">Logout</a>
    </div>

    <!-- Your Projects Section -->
    <div class="mb-5">
        <h2 class="text-center mb-4">Your Projects</h2>
        <div class="dashboard-grid">
            {% for project in user_projects %}
            <div class="dashboard-item blue">
                <h2>{{ project.name }}</h2>
                <p>{{ project.description }}</p>
                <a href="{% url 'projects:project-detail' project.id %}" class="btn btn-outline-light btn-sm">&#10132;</a>
                {% if user.permission_level == 'admin' %}
                    <a href="#" class="delete-project-btn" data-project-id="{{ project.id }}">&#10006;</a>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-center text-white">You have no projects.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Joined Projects Section -->
    <div class="mb-5">
        <h2 class="text-center mb-4">Joined Projects</h2>
        <div class="dashboard-grid">
            {% for project in joined_projects %}
            <div class="dashboard-item blue">
                <h2>{{ project.name }}</h2>
                <p>{{ project.description }}</p>
                <a href="{% url 'projects:project-detail' project.id %}" class="btn btn-outline-light btn-sm">&#10132;</a>
                {% if user.permission_level == 'admin' %}
                    <a href="#" class="delete-project-btn" data-project-id="{{ project.id }}">&#10006;</a>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-center text-white">You are not a member of any projects.</p>
            {% endfor %}
        </div>
    </div>

    <!-- All Projects Section -->
    <div class="mb-5">
        <h2 class="text-center mb-4">All Projects</h2>
        <div class="dashboard-grid">
            {% for project in all_projects %}
            <div class="dashboard-item pink">
                <h2>{{ project.name }}</h2>
                <p>{{ project.description }}</p>
                {% if project not in user_projects and project not in joined_projects %}
                    {% if project in requested_projects %}
                        <button class="btn btn-secondary" disabled>Requested</button>
                    {% else %}
                        <button class="btn btn-primary request-to-join-btn" data-project-id="{{ project.id }}">Request to Join</button>
                    {% endif %}
                {% endif %}
            </div>
            {% empty %}
            <p class="text-center text-white">No other projects available.</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Create Project Button -->
{% if user.permission_level != 'admin' %}
    <a href="{% url 'projects:create-project' %}" class="create-project-btn">Create a Project</a>
{% endif %}
{% else %}
<div class="container text-center my-5">
    <h1 class="display-4 mb-4">Welcome to the Academic Project Tracker</h1>
    <p class="lead mb-4">You are not logged in.</p>
    <a href="{% url 'social:begin' 'google-oauth2' %}" class="btn btn-primary btn-lg">Login with Google</a>
</div>
{% endif %}

<!-- AJAX for "Request to Join" Button -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.request-to-join-btn').forEach(button => {
            button.addEventListener('click', function(event) {
                const projectId = button.getAttribute('data-project-id');
                fetch(`/projects/${projectId}/request-to-join/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-secondary');
                        button.disabled = true;
                        button.innerHTML = 'Requested';
                        alert('Your request has been sent');
                    } else if (data.message === 'Already requested') {
                        alert('You have already requested to join this project');
                    } else {
                        alert('Failed to send request');
                    }
                });
            });
        });
    });
</script>
{% endblock %}
